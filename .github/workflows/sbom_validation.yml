name: SBOM Validation

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  sbom:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - name: Générer SBOM CycloneDX
        run: |
          mkdir -p docs
          if command -v cyclonedx-bom >/dev/null 2>&1; then
            cyclonedx-bom -o docs/sbom-cyclonedx.json
          else
            cat > docs/sbom-cyclonedx.json <<'JSON'
            {"status":"skipped","reason":"cyclonedx-bom not installed"}
            JSON
          fi
      - name: Générer SBOM SPDX
        run: |
          mkdir -p docs
          if command -v spdx-sbom-generator >/dev/null 2>&1; then
            spdx-sbom-generator -o docs/sbom-spdx.json
          else
            cat > docs/sbom-spdx.json <<'JSON'
            {"status":"skipped","reason":"spdx-sbom-generator not installed"}
            JSON
          fi
      - name: Valider SBOM (Trivy)
        run: |
          mkdir -p docs
          if command -v trivy >/dev/null 2>&1; then
            trivy sbom docs/sbom-cyclonedx.json --format json --output docs/sbom-trivy-report.json
          else
            cat > docs/sbom-trivy-report.json <<'JSON'
            {"status":"skipped","reason":"trivy not installed"}
            JSON
          fi
      - name: Valider SBOM (Snyk)
        run: |
          mkdir -p docs
          if command -v snyk >/dev/null 2>&1; then
            snyk test --file=docs/sbom-cyclonedx.json --json > docs/sbom-snyk-report.json || true
          else
            cat > docs/sbom-snyk-report.json <<'JSON'
            {"status":"skipped","reason":"snyk not installed"}
            JSON
          fi
      - name: Upload SBOM & reports
        uses: actions/upload-artifact@v4
        with:
          name: sbom-validation
          path: |
            docs/sbom-cyclonedx.json
            docs/sbom-spdx.json
            docs/sbom-trivy-report.json
            docs/sbom-snyk-report.json
